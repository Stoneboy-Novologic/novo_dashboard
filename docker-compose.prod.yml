# Docker Compose for Production Environment (EC2)
# 
# This file sets up the complete production stack:
# - PostgreSQL database with persistent volume
# - NestJS backend API (internal port 3001)
# - Next.js frontend (internal port 3000)
# - Nginx reverse proxy (port 80/443) - optional
#
# Usage:
#   docker-compose -f docker-compose.prod.yml up -d
#   docker-compose -f docker-compose.prod.yml logs -f
#   docker-compose -f docker-compose.prod.yml down
#
# Environment Variables:
#   Must be set in .env.production file or environment
#   See .env.example for required variables
#
# Security Notes:
#   - Use strong passwords for database
#   - Set secure JWT secrets
#   - Configure proper CORS origins
#   - Use HTTPS in production (configure Nginx)

version: '3.8'

services:
  # PostgreSQL Database Service (Production)
  postgres:
    image: postgres:16-alpine
    container_name: construction-mgmt-postgres-prod
    restart: always
    environment:
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_DATABASE}
      PGDATA: /var/lib/postgresql/data/pgdata
    # Don't expose ports in production - only internal access
    # ports:
    #   - "5432:5432"
    volumes:
      # Persistent data storage
      - postgres_data:/var/lib/postgresql/data
      # Backup volume (optional)
      - postgres_backups:/var/backups/postgres
    networks:
      - construction-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME}"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    # Production logging
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # NestJS Backend API Service (Production)
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
      target: production
    container_name: construction-mgmt-api-prod
    restart: always
    environment:
      # Node environment
      NODE_ENV: production
      PORT: 3001
      
      # Database configuration
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DATABASE: ${DB_DATABASE}
      
      # JWT Configuration (MUST be set securely)
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-1h}
      REFRESH_TOKEN_EXPIRES_IN: ${REFRESH_TOKEN_EXPIRES_IN:-7d}
      
      # OAuth Configuration
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_CALLBACK_URL: ${GOOGLE_CALLBACK_URL}
      MICROSOFT_CLIENT_ID: ${MICROSOFT_CLIENT_ID:-}
      MICROSOFT_CLIENT_SECRET: ${MICROSOFT_CLIENT_SECRET:-}
      MICROSOFT_CALLBACK_URL: ${MICROSOFT_CALLBACK_URL}
      MICROSOFT_TENANT: ${MICROSOFT_TENANT:-common}
      
      # CORS Configuration (set to your domain)
      CORS_ORIGIN: ${CORS_ORIGIN}
      
      # File Upload Configuration
      MAX_FILE_SIZE: ${MAX_FILE_SIZE:-10485760}
      ALLOWED_FILE_TYPES: ${ALLOWED_FILE_TYPES:-image/jpeg,image/png,image/gif,application/pdf}
      UPLOAD_DIR: /app/uploads
      
      # Logging Configuration
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-json}
    # Don't expose ports directly - use reverse proxy
    # ports:
    #   - "3001:3001"
    volumes:
      # Mount uploads directory for file persistence
      - api_uploads:/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - construction-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Next.js Frontend Application Service (Production)
  app:
    build:
      context: .
      dockerfile: Dockerfile.app
      target: production
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    container_name: construction-mgmt-app-prod
    restart: always
    environment:
      # Node environment
      NODE_ENV: production
      PORT: 3000
      
      # API URL for frontend
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
      
      # Next.js configuration
      NEXT_TELEMETRY_DISABLED: 1
    # Don't expose ports directly - use reverse proxy
    # ports:
    #   - "3000:3000"
    depends_on:
      - api
    networks:
      - construction-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Nginx Reverse Proxy (Optional - for HTTPS and routing)
  # Uncomment and configure if you want to use Nginx
  # nginx:
  #   image: nginx:alpine
  #   container_name: construction-mgmt-nginx
  #   restart: always
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./ec2/nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./ec2/ssl:/etc/nginx/ssl:ro
  #   depends_on:
  #     - app
  #     - api
  #   networks:
  #     - construction-network
  #   healthcheck:
  #     test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

# Named volumes for data persistence
volumes:
  postgres_data:
    driver: local
    name: construction-mgmt-postgres-data-prod
  postgres_backups:
    driver: local
    name: construction-mgmt-postgres-backups
  api_uploads:
    driver: local
    name: construction-mgmt-api-uploads-prod

# Network for service communication
networks:
  construction-network:
    driver: bridge
    name: construction-mgmt-network-prod

